\ProvidesPackage{pkgtest}[2009/03/13 v0.1 Test suite for LaTeX packages]
% Copyright (c) 2009 - Martin Scharrer <martin@scharrer-online.de>
% This file is under the LaTeX Project Public Licence (LPPL) v1.3c or later.

\RequirePackage{ifthen}
\RequirePackage{xspace}
\RequirePackage{xcolor}

\newcommand*{\PASSED}{\textcolor{green}{\textbf{\sffamily PASSED}}}
\newcommand*{\FAILED}{\textcolor{red}{\textbf{\sffamily FAILED}}}

\newcounter{testnum}
\setcounter{testnum}{1}
\newcounter{testsubnum}[testnum]
\newcounter{failedtest}

\newcommand*\testtitle[1]{%
  \def\@title{#1}
}
\newcommand*\testnum{%
  \setcounter{testnum}
}

\providecommand*\cs[1]{%
  \texttt{\textbackslash #1}
}

\def\maketitle{%
  \begingroup
  \hbox{}
  \bigskip
  \begin{center}
  {\Huge\sffamily Test \thetestnum: \@title}
  \bigskip
  \par{Compiled: \today}
  \end{center}
  \bigskip \bigskip
  \endgroup
  \par\noindent
}

\def\packgeundertest{}
\def\packgeundertestoptions{}

\newcommand*\testpackage[2][]{%
  \def\packgeundertest{#2}
  \def\packgeundertestoptions{#1}
  \usepackage[#1]{#2}%
}

\newif\iftestprintresult
\testprintresulttrue

\newif\iftestcausetexerror
\@ifundefined{testnotexerror}{\testcausetexerrortrue}{}

\let\TestInfo=\GenericInfo

\providecommand*{\@gobblefour}[4]{}

\newcommand*\TestError{%
  \iftestcausetexerror
    \expandafter\GenericError
  \else
    \expandafter\@gobblefour
  \fi
}

\begingroup
\catcode`#=12
\gdef\hashchar{#}
\endgroup

\renewcommand{\thetestnum}{\hashchar\arabic{testnum}}
\renewcommand{\thetestsubnum}{\hashchar\arabic{testnum}-\arabic{testsubnum}}

\newcommand*\testequal[2]{%
 \refstepcounter{testsubnum}%
 \def\testa{``#1''}%
 \def\testb{``#2''}%
 \def\testop{string equal}%
  \ifthenelse{\equal{#1}{#2}}%
    {\testsuccess}%
    {\testfailure}%
}

\newcommand\testsuccess[1][]{%
  \TestInfo{pkgtest}{pkgtest: Test \thetestsubnum\space passed.^^J
  Test label: #1^^J}{}%
  \iftestprintresult
    \medskip\par\noindent
    \PASSED: \thetestsubnum\ #1\\
    \testa\ is \testop\ to \testb
  \fi
}

\newcommand\testfailure[1][]{%
  \refstepcounter{failedtest}
  \TestError{pkgtest}{pkgtest: Test \thetestsubnum\space failed!^^J%
  Test label: #1^^J%
  Test operation: \testop^^J%
  Test argument 1: \testa^^J%
  Test argument 2: \testb^^J%
  }{}{}%
  \iftestprintresult
    \medskip\par\noindent
    \FAILED: \thetestsubnum\ #1\\
    \testa\ is NOT \testop\ to \testb
  \fi
}

\AtEndDocument{%
  \testresults
}

\newcommand*\testresults{%
  \iftestprintresult
  \section*{Final Test Results}
  \ifthenelse{\value{failedtest}>0}%
    {{\Huge\FAILED}: \arabic{failedtest}\ error(s) detected!}%
    {{\Huge\PASSED}: All \arabic{testsubnum}\ tests were successful.}%
  \fi

  \message{pkgtest: Test Results:^^J}
  \ifthenelse{\value{failedtest}>0}%
    {\message{FAILED: \arabic{failedtest}\space error(s) detected!^^J^^J}}%
    {\message{PASSED: All \arabic{testsubnum}\space tests were successful.^^J^^J}}%
}

